# DevSecOps Security Scan Workflow
# This workflow was added by the DevSecOps Platform
# It runs security scanners on your repository

name: DevSecOps Security Scan

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: 'Scan Job ID'
        required: true
        type: string
      scanners:
        description: 'Comma-separated list of scanners to run'
        required: true
        type: string

permissions:
  contents: read
  security-events: write

env:
  JOB_ID: ${{ github.event.inputs.job_id }}

jobs:
  scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up scan environment
        id: setup
        run: |
          echo "Starting security scan for job: ${{ env.JOB_ID }}"
          SCANNERS="${{ github.event.inputs.scanners }}"
          echo "Scanners to run: $SCANNERS"
          
          # Parse scanners into flags
          [[ "$SCANNERS" == *"semgrep"* ]] && echo "run_semgrep=true" >> $GITHUB_OUTPUT || echo "run_semgrep=false" >> $GITHUB_OUTPUT
          [[ "$SCANNERS" == *"gitleaks"* ]] && echo "run_gitleaks=true" >> $GITHUB_OUTPUT || echo "run_gitleaks=false" >> $GITHUB_OUTPUT
          [[ "$SCANNERS" == *"trivy"* ]] && echo "run_trivy=true" >> $GITHUB_OUTPUT || echo "run_trivy=false" >> $GITHUB_OUTPUT
          [[ "$SCANNERS" == *"osv-scanner"* ]] && echo "run_osv=true" >> $GITHUB_OUTPUT || echo "run_osv=false" >> $GITHUB_OUTPUT
          [[ "$SCANNERS" == *"syft"* ]] && echo "run_syft=true" >> $GITHUB_OUTPUT || echo "run_syft=false" >> $GITHUB_OUTPUT

      # Semgrep SAST
      - name: Run Semgrep
        if: steps.setup.outputs.run_semgrep == 'true'
        uses: docker://semgrep/semgrep:latest
        with:
          args: semgrep scan --config auto --json --output semgrep-results.json .
        continue-on-error: true

      - name: Ensure Semgrep results exist
        if: steps.setup.outputs.run_semgrep == 'true'
        run: |
          if [ ! -f semgrep-results.json ]; then
            echo '{"results":[],"errors":[]}' > semgrep-results.json
          fi

      - name: Upload Semgrep results
        if: steps.setup.outputs.run_semgrep == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results-${{ env.JOB_ID }}
          path: semgrep-results.json

      # Gitleaks Secrets Detection
      - name: Run Gitleaks
        if: steps.setup.outputs.run_gitleaks == 'true'
        uses: docker://zricethezav/gitleaks:latest
        with:
          args: detect --source=. --report-path=gitleaks-results.json --report-format=json --no-git --exit-code 0
        continue-on-error: true

      - name: Ensure Gitleaks results exist
        if: steps.setup.outputs.run_gitleaks == 'true'
        run: |
          if [ ! -f gitleaks-results.json ]; then
            echo '[]' > gitleaks-results.json
          fi

      - name: Upload Gitleaks results
        if: steps.setup.outputs.run_gitleaks == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-results-${{ env.JOB_ID }}
          path: gitleaks-results.json

      # Trivy Vulnerability Scanner
      - name: Run Trivy
        if: steps.setup.outputs.run_trivy == 'true'
        uses: docker://aquasec/trivy:latest
        with:
          args: fs --format json --output trivy-results.json .
        continue-on-error: true

      - name: Ensure Trivy results exist
        if: steps.setup.outputs.run_trivy == 'true'
        run: |
          if [ ! -f trivy-results.json ]; then
            echo '{"Results":[]}' > trivy-results.json
          fi

      - name: Upload Trivy results
        if: steps.setup.outputs.run_trivy == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-${{ env.JOB_ID }}
          path: trivy-results.json

      # OSV-Scanner
      - name: Run OSV-Scanner
        if: steps.setup.outputs.run_osv == 'true'
        uses: docker://ghcr.io/google/osv-scanner:latest
        with:
          args: --format json -r . > osv-results.json
        continue-on-error: true

      - name: Ensure OSV results exist
        if: steps.setup.outputs.run_osv == 'true'
        run: |
          if [ ! -f osv-results.json ] || [ ! -s osv-results.json ]; then
            echo '{"results":[]}' > osv-results.json
          fi

      - name: Upload OSV results
        if: steps.setup.outputs.run_osv == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: osv-results-${{ env.JOB_ID }}
          path: osv-results.json

      # Syft SBOM
      - name: Run Syft
        if: steps.setup.outputs.run_syft == 'true'
        run: |
          docker run --rm -v "$PWD:/src" anchore/syft:latest /src -o json > syft-sbom.json || true
          if [ ! -s syft-sbom.json ]; then
            echo '{"artifacts":[]}' > syft-sbom.json
          fi
        continue-on-error: true

      - name: Upload Syft results
        if: steps.setup.outputs.run_syft == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: syft-sbom-${{ env.JOB_ID }}
          path: syft-sbom.json

      # Summary
      - name: Create Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Job ID:** ${{ env.JOB_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scanners:** ${{ github.event.inputs.scanners }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          ls -la *.json 2>/dev/null || echo "No JSON results found"
